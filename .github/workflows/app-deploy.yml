name: App Deploy

on:
  push:
    branches: [main]
    paths:
      - "app/**"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-dev:
    name: Deploy app to dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::939503809934:role/cicd-deploy-role

      - name: Deploy to dev
        run: |
          chmod +x .github/scripts/deploy_app.sh
          .github/scripts/deploy_app.sh dev 939503809934 ap-southeast-2

  # =========================
  # QA (disabled for demo)
  # =========================
  # deploy-qa:
  #   name: Deploy app to qa
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Configure AWS credentials (qa)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-region: ap-southeast-2
  #         role-to-assume: arn:aws:iam::222222222222:role/cicd-deploy-role
  #     - name: Deploy to qa
  #       run: |
  #         chmod +x .github/scripts/deploy_app.sh
  #         .github/scripts/deploy_app.sh qa 222222222222 ap-southeast-2

  # =========================
  # STAGING (disabled for demo)
  # =========================
  # deploy-staging:
  #   name: Deploy app to staging
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Configure AWS credentials (staging)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-region: ap-southeast-2
  #         role-to-assume: arn:aws:iam::333333333333:role/cicd-deploy-role
  #     - name: Deploy to staging
  #       run: |
  #         chmod +x .github/scripts/deploy_app.sh
  #         .github/scripts/deploy_app.sh staging 333333333333 ap-southeast-2

  # =========================
  # PRODUCTION (disabled for demo; requires approval)
  # =========================
  # deploy-production:
  #   name: Deploy app to production
  #   runs-on: ubuntu-latest
  #   environment: production   # GitHub Environment approval gate
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Configure AWS credentials (production)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-region: ap-southeast-2
  #         role-to-assume: arn:aws:iam::444444444444:role/cicd-deploy-role
  #     - name: Deploy to production
  #       run: |
  #         chmod +x .github/scripts/deploy_app.sh
  #         .github/scripts/deploy_app.sh production 444444444444 ap-southeast-2