name: Infra

on:
  pull_request:
    paths:
      - "infra/**"
  push:
    branches: [main]
    paths:
      - "infra/**"

permissions:
  id-token: write
  contents: read

jobs:
  # =========================
  # PR: synth + diff (dev)
  # =========================
  infra-pr-dev:
    name: Infra PR â€“ CDK synth & diff (dev)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: infra/package-lock.json

      - name: Install dependencies
        working-directory: infra
        run: npm ci

      - name: CDK synth
        working-directory: infra
        run: npx cdk synth

      # NOTE:
      # cdk diff without AWS credentials will still show template-level changes.
      - name: CDK diff (no deploy)
        working-directory: infra
        run: npx cdk diff

  # =========================
  # MAIN: deploy infra (dev)
  # =========================
  infra-deploy-dev:
    name: Infra Deploy (dev)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: infra/package-lock.json

      - name: Configure AWS credentials (dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-southeast-2
          role-to-assume: arn:aws:iam::939503809934:role/cicd-deploy-role

      - name: Install dependencies
        working-directory: infra
        run: npm ci

      - name: CDK deploy (dev)
        working-directory: infra
        env:
          ENV_NAME: dev
        run: |
          npx cdk deploy "order-processing-${ENV_NAME}" \
            --require-approval never \
            -c env="${ENV_NAME}"

  # =========================
  # QA / STAGING / PROD
  # (intentionally disabled for demo)
  # =========================

  # infra-deploy-qa:
  # infra-deploy-staging:
  # infra-deploy-production:
  #   environment: production   # approval gate